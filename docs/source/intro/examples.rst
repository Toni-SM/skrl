.. _examples:

Examples
========

In this section, you will find a variety of examples that demonstrate how to use this library to solve reinforcement learning tasks. With the knowledge and skills you gain from trying these examples, you will be well on your way to using this library to solve your reinforcement learning problems

.. contents:: Table of Contents
   :depth: 2
   :local:
   :backlinks: none

.. raw:: html

   <br>

.. note::

    It is recommended to use the Table of Contents in the sidebar or in this section to improve the browsing experience

.. raw:: html

   <hr><hr>

Gym/Gymnasium
-------------

.. contents::
   :depth: 2
   :local:
   :backlinks: none

.. raw:: html

   <hr>

Gym/Gymnasium environments
^^^^^^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of one agent in a Gym/Gymnasium environment (**one agent, one environment**)

.. image:: ../_static/imgs/example_gym.png
      :width: 100%
      :align: center
      :alt: Gym/Gymnasium environments

.. raw:: html

   <br>

The following components or practices are exemplified (highlighted):

    - Load and wrap a Gym environment: **Pendulum (DDPG)**, **CartPole (CEM)**
    - Recurrent neural network models (RNN, GRU, LSTM): **PendulumNoVel (DDPG)**
    - Instantiate models using the model instantiation utility: **CartPole (DQN)**
    - Create a tabular model (:math:`\epsilon`-greedy policy): **Taxi (SARSA)**, **FrozenLake (Q-Learning)**
    - Load a checkpoint during evaluation: **Pendulum (DDPG)**, **CartPole (CEM)**, **CartPole (DQN)**, **Taxi (SARSA)**, **FrozenLake (Q-Learning)**

**Benchmark results** are listed in `Benchmark results #32 (Gym/Gymnasium) <https://github.com/Toni-SM/skrl/discussions/32#discussioncomment-4308370>`_

.. tabs::

    .. tab:: Pendulum (DDPG)

        .. tabs::

            .. group-tab:: Training

                | :download:`ddpg_gym_pendulum.py <../examples/gym/ddpg_gym_pendulum.py>`
                | :download:`ddpg_gymnasium_pendulum.py <../examples/gymnasium/ddpg_gymnasium_pendulum.py>`

                .. literalinclude:: ../examples/gym/ddpg_gym_pendulum.py
                    :language: python
                    :emphasize-lines: 1, 13, 51-57

            .. group-tab:: Evaluation

                | :download:`ddpg_gym_pendulum_eval.py <../examples/gym/ddpg_gym_pendulum_eval.py>`
                | :download:`ddpg_gymnasium_pendulum_eval.py <../examples/gymnasium/ddpg_gymnasium_pendulum_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/gym/ddpg_gym_pendulum_eval.py
                    :language: python
                    :emphasize-lines: 67

    .. tab:: PendulumNoVel (DDPG)

        .. note::

            The examples use a wrapper around the original environment to mask the velocity in the observation. The intention is to make the MDP partially observable and to show the capabilities of recurrent neural networks

        More examples with other algorithms can be found in the repository documentation `example folder <https://github.com/Toni-SM/skrl/tree/main/docs/source/examples/gym>`_ and in the benchmark results indicated above

        .. tabs::

            .. tab:: RNN

                .. tabs::

                    .. group-tab:: Training

                        | :download:`ddpg_gym_pendulumnovel_rnn.py <../examples/gym/ddpg_gym_pendulumnovel_rnn.py>`

                        .. literalinclude:: ../examples/gym/ddpg_gym_pendulumnovel_rnn.py
                            :language: python
                            :emphasize-lines: 11, 31-34, 40-43, 50-77, 86, 99-102, 108-111, 118-141, 149

            .. tab:: GRU

                .. tabs::

                    .. group-tab:: Training

                        | :download:`ddpg_gym_pendulumnovel_gru.py <../examples/gym/ddpg_gym_pendulumnovel_gru.py>`

                        .. literalinclude:: ../examples/gym/ddpg_gym_pendulumnovel_gru.py
                            :language: python
                            :emphasize-lines: 11, 31-34, 40-43, 50-77, 86, 99-102, 108-111, 118-141, 149

            .. tab:: LSTM

                .. tabs::

                    .. group-tab:: Training

                        | :download:`ddpg_gym_pendulumnovel_lstm.py <../examples/gym/ddpg_gym_pendulumnovel_lstm.py>`

                        .. literalinclude:: ../examples/gym/ddpg_gym_pendulumnovel_lstm.py
                            :language: python
                            :emphasize-lines: 11, 31-34, 40-44, 51-82, 91, 104-107, 113-117, 127-151, 159

    .. tab:: CartPole (CEM)

        .. tabs::

            .. group-tab:: Training

                | :download:`cem_gym_cartpole.py <../examples/gym/cem_gym_cartpole.py>`
                | :download:`cem_gymnasium_cartpole.py <../examples/gymnasium/cem_gymnasium_cartpole.py>`

                .. literalinclude:: ../examples/gym/cem_gym_cartpole.py
                    :language: python
                    :emphasize-lines: 1, 11, 33-39

            .. group-tab:: Evaluation

                | :download:`cem_gym_cartpole_eval.py <../examples/gym/cem_gym_cartpole_eval.py>`
                | :download:`cem_gymnasium_cartpole_eval.py <../examples/gymnasium/cem_gymnasium_cartpole_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/gym/cem_gym_cartpole_eval.py
                    :language: python
                    :emphasize-lines: 68

    .. tab:: CartPole (DQN)

        .. tabs::

            .. group-tab:: Training

                | :download:`dqn_gym_cartpole.py <../examples/gym/dqn_gym_cartpole.py>`
                | :download:`dqn_gymnasium_cartpole.py <../examples/gymnasium/dqn_gymnasium_cartpole.py>`

                .. literalinclude:: ../examples/gym/dqn_gym_cartpole.py
                    :language: python
                    :emphasize-lines: 4, 31-51

            .. group-tab:: Evaluation

                | :download:`dqn_gym_cartpole_eval.py <../examples/gym/dqn_gym_cartpole_eval.py>`
                | :download:`dqn_gymnasium_cartpole_eval.py <../examples/gymnasium/dqn_gymnasium_cartpole_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/gym/dqn_gym_cartpole_eval.py
                    :language: python
                    :emphasize-lines: 56

    .. tab:: Taxi (SARSA)

        .. tabs::

            .. group-tab:: Training

                | :download:`sarsa_gym_taxi.py <../examples/gym/sarsa_gym_taxi.py>`
                | :download:`sarsa_gymnasium_taxi.py <../examples/gymnasium/sarsa_gymnasium_taxi.py>`

                .. literalinclude:: ../examples/gym/sarsa_gym_taxi.py
                    :language: python
                    :emphasize-lines: 6, 13-30

            .. group-tab:: Evaluation

                | :download:`sarsa_gym_taxi_eval.py <../examples/gym/sarsa_gym_taxi_eval.py>`
                | :download:`sarsa_gymnasium_taxi_eval.py <../examples/gymnasium/sarsa_gymnasium_taxi_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/gym/sarsa_gym_taxi_eval.py
                    :language: python
                    :emphasize-lines: 70

    .. tab:: FrozenLake (Q-learning)

        .. tabs::

            .. group-tab:: Training

                | :download:`q_learning_gym_frozen_lake.py <../examples/gym/q_learning_gym_frozen_lake.py>`
                | :download:`q_learning_gymnasium_frozen_lake.py <../examples/gymnasium/q_learning_gymnasium_frozen_lake.py>`

                .. literalinclude:: ../examples/gym/q_learning_gym_frozen_lake.py
                    :language: python
                    :emphasize-lines: 6, 13-30

            .. group-tab:: Evaluation

                | :download:`q_learning_gym_frozen_lake_eval.py <../examples/gym/q_learning_gym_frozen_lake_eval.py>`
                | :download:`q_learning_gymnasium_frozen_lake_eval.py <../examples/gymnasium/q_learning_gymnasium_frozen_lake_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/gym/q_learning_gym_frozen_lake_eval.py
                    :language: python
                    :emphasize-lines: 70

.. raw:: html

   <hr>

Gym/Gymnasium vectorized environments
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of one agent in a Gym/Gymnasium vectorized environment (**one agent, multiple independent copies of the same environment in parallel**)

The following components or practices are exemplified (highlighted):

    - Load and wrap a Gym vectorized environment: **Pendulum (DDPG)**, **CartPole (DQN)**, **Taxi (SARSA)**, **FrozenLake (Q-Learning)**

.. tabs::

    .. tab:: Pendulum (DDPG)

        .. tabs::

            .. group-tab:: Training

                | :download:`ddpg_gym_pendulum_vector.py <../examples/gym/ddpg_gym_pendulum_vector.py>`
                | :download:`ddpg_gymnasium_pendulum_vector.py <../examples/gymnasium/ddpg_gymnasium_pendulum_vector.py>`

                .. literalinclude:: ../examples/gym/ddpg_gym_pendulum_vector.py
                    :language: python
                    :emphasize-lines: 1, 13, 50-56

    .. tab:: CartPole (DQN)

        .. tabs::

            .. group-tab:: Training

                | :download:`dqn_gym_cartpole_vector.py <../examples/gym/dqn_gym_cartpole_vector.py>`
                | :download:`dqn_gymnasium_cartpole_vector.py <../examples/gymnasium/dqn_gymnasium_cartpole_vector.py>`

                .. literalinclude:: ../examples/gym/dqn_gym_cartpole_vector.py
                    :language: python
                    :emphasize-lines: 1, 8, 13-19

    .. tab:: Taxi (SARSA)

        .. tabs::

            .. group-tab:: Training

                | :download:`sarsa_gym_taxi_vector.py <../examples/gym/sarsa_gym_taxi_vector.py>`
                | :download:`sarsa_gymnasium_taxi_vector.py <../examples/gymnasium/sarsa_gymnasium_taxi_vector.py>`

                .. literalinclude:: ../examples/gym/sarsa_gym_taxi_vector.py
                    :language: python
                    :emphasize-lines: 1, 9, 35-41

    .. tab:: FrozenLake (Q-learning)

        .. tabs::

            .. group-tab:: Training

                | :download:`q_learning_gym_frozen_lake_vector.py <../examples/gym/q_learning_gym_frozen_lake_vector.py>`
                | :download:`q_learning_gymnasium_frozen_lake_vector.py <../examples/gymnasium/q_learning_gymnasium_frozen_lake_vector.py>`

                .. literalinclude:: ../examples/gym/q_learning_gym_frozen_lake_vector.py
                    :language: python
                    :emphasize-lines: 1, 9, 35-41

.. raw:: html

   <hr>

Farama Shimmy (converted environments)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The following examples show the training in several popular environments (Atari, DeepMind Control and OpenAI Gym) that have been converted to the Gymnasium API using the `Shimmy <https://github.com/Farama-Foundation/Shimmy>`_ (API conversion tool) package

.. image:: ../_static/imgs/example_shimmy.png
      :width: 100%
      :align: center
      :alt: Shimmy (converted environments)

.. note::

    From **skrl**, no extra implementation is necessary, since it fully supports Gymnasium API

.. note::

    Because the Gymnasium API requires that the rendering mode be specified during the initialization of the environment, it is not enough to set the :literal:`headless` option in the trainer configuration to render the environment. In this case, it is necessary to call the :literal:`gymnasium.make` function using :literal:`render_mode="human"` or any other supported option

.. tabs::

    .. tab:: Atari: Pong (DQN)

        .. tabs::

            .. group-tab:: Training

                | :download:`dqn_shimmy_atari_pong.py <../examples/shimmy/dqn_shimmy_atari_pong.py>`

                .. literalinclude:: ../examples/shimmy/dqn_shimmy_atari_pong.py
                    :language: python

    .. tab:: DeepMind: Acrobot (SAC)

        .. tabs::

            .. group-tab:: Training

                | :download:`sac_shimmy_dm_control_acrobot_swingup_sparse.py <../examples/shimmy/sac_shimmy_dm_control_acrobot_swingup_sparse.py>`

                .. literalinclude:: ../examples/shimmy/sac_shimmy_dm_control_acrobot_swingup_sparse.py
                    :language: python

    .. tab:: Gym compatibility (DDPG)

        .. tabs::

            .. group-tab:: Training

                | :download:`ddpg_openai_gym_compatibility_pendulum.py <../examples/shimmy/ddpg_openai_gym_compatibility_pendulum.py>`

                .. literalinclude:: ../examples/shimmy/ddpg_openai_gym_compatibility_pendulum.py
                    :language: python

.. raw:: html

   <hr><hr>

Other supported APIs
--------------------

.. contents::
   :depth: 2
   :local:
   :backlinks: none

.. raw:: html

   <hr>

DeepMind environments
^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of one agent in a DeepMind environment (**one agent, one environment**)

.. image:: ../_static/imgs/example_deepmind.png
      :width: 100%
      :align: center
      :alt: DeepMind environments

.. raw:: html

   <br>

The following components or practices are exemplified (highlighted):

    - Load and wrap a DeepMind environment: **cartpole (DDPG)**
    - Map the observation/state space (flat tensor) to the original environment space to be used by the model: **reach_site_vision (SAC)**

.. tabs::

    .. tab:: suite:cartpole (DDPG)

        .. tabs::

            .. group-tab:: Training

                :download:`dm_suite_cartpole_swingup_ddpg.py <../examples/deepmind/dm_suite_cartpole_swingup_ddpg.py>`

                .. literalinclude:: ../examples/deepmind/dm_suite_cartpole_swingup_ddpg.py
                    :language: python
                    :emphasize-lines: 1, 13, 50-51

    .. tab:: manipulation:reach_site_vision (SAC)

        .. tabs::

            .. group-tab:: Training

                :download:`dm_manipulation_stack_sac.py <../examples/deepmind/dm_manipulation_stack_sac.py>`

                .. literalinclude:: ../examples/deepmind/dm_manipulation_stack_sac.py
                    :language: python
                    :emphasize-lines: 69, 82, 85-86, 118, 121, 124-125

.. raw:: html

   <hr>

Robosuite environments
^^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of one agent in a robosuite environment (**one agent, one environment**)

.. image:: ../_static/imgs/example_robosuite.png
      :width: 50%
      :align: center
      :alt: robosuite environments

.. raw:: html

   <br>

The following components or practices are exemplified (highlighted):

    - Load and wrap a robosuite environment: **TwoArmLift (TD3)**

.. tabs::

    .. tab:: robosuite:TwoArmLift (TD3)

        .. tabs::

            .. group-tab:: Training

                :download:`td3_robosuite_two_arm_lift.py <../examples/robosuite/td3_robosuite_two_arm_lift.py>` (not tuned)

                .. literalinclude:: ../examples/robosuite/td3_robosuite_two_arm_lift.py
                    :language: python
                    :emphasize-lines: 1-2, 51-65

.. raw:: html

   <hr><hr>

Isaac Gym preview
-----------------

.. contents::
   :depth: 2
   :local:
   :backlinks: none

.. raw:: html

   <hr>

Isaac Gym environments
^^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of an agent in the `Isaac Gym environments <https://github.com/NVIDIA-Omniverse/IsaacGymEnvs>`_ (**one agent, multiple environments**)

.. image:: ../_static/imgs/example_isaacgym.png
      :width: 100%
      :align: center
      :alt: Isaac Gym environments

.. raw:: html

   <br>

The following components or practices are exemplified (highlighted):

    - Load an Isaac Gym environment (easy-to-use API from NVIDIA): **AllegroHand**, **Ingenuity**
    - Load and wrap an Isaac Gym environment: **Ant**, **Anymal**
    - Set an input preprocessor: **AnymalTerrain**, **BallBalance**
    - Set a random seed for reproducibility: **Cartpole**
    - Set a learning rate scheduler: **FrankaCabinet**, **Humanoid**
    - Define a reward shaping function: **Quadcopter**, **ShadowHand**, **Trifinger**
    - Access to environment-specific properties and methods: **Humanoid (AMP)**
    - Load a checkpoint during evaluation: **Cartpole**

The PPO agent configuration is mapped, as far as possible, from the rl_games' A2C-PPO `configuration for Isaac Gym preview environments <https://github.com/NVIDIA-Omniverse/IsaacGymEnvs/tree/main/isaacgymenvs/cfg/train>`_. Shared models or separated models are used depending on the value of the :literal:`network.separate` variable. The following list shows the mapping between the two configurations:

.. code-block:: bash

    # memory
    memory_size = horizon_length

    # agent
    rollouts = horizon_length
    learning_epochs = mini_epochs
    mini_batches = horizon_length * num_actors / minibatch_size
    discount_factor = gamma
    lambda = tau
    learning_rate = learning_rate
    learning_rate_scheduler = skrl.resources.schedulers.torch.KLAdaptiveRL
    learning_rate_scheduler_kwargs = {"kl_threshold": kl_threshold}
    random_timesteps = 0
    learning_starts = 0
    grad_norm_clip = grad_norm
    ratio_clip = e_clip
    value_clip = e_clip
    clip_predicted_values = clip_value
    entropy_loss_scale = entropy_coef
    value_loss_scale = 0.5 * critic_coef
    kl_threshold = 0
    rewards_shaper = lambda rewards, timestep, timesteps: rewards * scale_value

    # trainer
    timesteps = horizon_length * max_epochs

**Benchmark results** are listed in `Benchmark results #32 (NVIDIA Isaac Gym) <https://github.com/Toni-SM/skrl/discussions/32#discussioncomment-3774815>`_

.. note::

    Isaac Gym environments implement a functionality to get their configuration from the command line. Because of this feature, setting the :literal:`headless` option from the trainer configuration will not work. In this case, it is necessary to invoke the scripts as follows: :literal:`python script.py headless=True` for Isaac Gym environments (preview 3 and preview 4) or :literal:`python script.py --headless` for Isaac Gym environments (preview 2)

.. tabs::

    .. tab:: Isaac Gym environments (training)

        .. tabs::

            .. tab:: AllegroHand

                :download:`ppo_allegro_hand.py <../examples/isaacgym/ppo_allegro_hand.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_allegro_hand.py
                    :language: python
                    :emphasize-lines: 2, 19, 56-62

            .. tab:: Ant

                :download:`ppo_ant.py <../examples/isaacgym/ppo_ant.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_ant.py
                    :language: python
                    :emphasize-lines: 13-14, 56-57

            .. tab:: Anymal

                :download:`ppo_anymal.py <../examples/isaacgym/ppo_anymal.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_anymal.py
                    :language: python
                    :emphasize-lines: 13-14, 56-57

            .. tab:: AnymalTerrain

                :download:`ppo_anymal_terrain.py <../examples/isaacgym/ppo_anymal_terrain.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_anymal_terrain.py
                    :language: python
                    :emphasize-lines: 11, 101-104

            .. tab:: BallBalance

                :download:`ppo_ball_balance.py <../examples/isaacgym/ppo_ball_balance.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_ball_balance.py
                    :language: python
                    :emphasize-lines: 11, 96-99

            .. tab:: Cartpole

                :download:`ppo_cartpole.py <../examples/isaacgym/ppo_cartpole.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_cartpole.py
                    :language: python
                    :emphasize-lines: 15, 19

            .. tab:: Cartpole (TRPO)

                :download:`trpo_cartpole.py <../examples/isaacgym/trpo_cartpole.py>`

                .. literalinclude:: ../examples/isaacgym/trpo_cartpole.py
                    :language: python
                    :emphasize-lines: 14, 18

            .. tab:: FrankaCabinet

                :download:`ppo_franka_cabinet.py <../examples/isaacgym/ppo_franka_cabinet.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_franka_cabinet.py
                    :language: python
                    :emphasize-lines: 10, 84-85

            .. tab:: Humanoid

                :download:`ppo_humanoid.py <../examples/isaacgym/ppo_humanoid.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_humanoid.py
                    :language: python
                    :emphasize-lines: 10, 84-85

            .. tab:: Humanoid (AMP)

                :download:`amp_humanoid.py <../examples/isaacgym/amp_humanoid.py>`

                .. literalinclude:: ../examples/isaacgym/amp_humanoid.py
                    :language: python
                    :emphasize-lines: 89, 124, 135, 138-139

            .. tab:: Ingenuity

                :download:`ppo_ingenuity.py <../examples/isaacgym/ppo_ingenuity.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_ingenuity.py
                    :language: python
                    :emphasize-lines: 2, 19, 56-62

            .. tab:: Quadcopter

                :download:`ppo_quadcopter.py <../examples/isaacgym/ppo_quadcopter.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_quadcopter.py
                    :language: python
                    :emphasize-lines: 95

            .. tab:: ShadowHand

                :download:`ppo_shadow_hand.py <../examples/isaacgym/ppo_shadow_hand.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_shadow_hand.py
                    :language: python
                    :emphasize-lines: 97

            .. tab:: Trifinger

                :download:`ppo_trifinger.py <../examples/isaacgym/ppo_trifinger.py>`

                .. literalinclude:: ../examples/isaacgym/ppo_trifinger.py
                    :language: python
                    :emphasize-lines: 95

    .. tab:: Isaac Gym environments (evaluation)

        .. tabs::

            .. tab:: Cartpole

                :download:`ppo_cartpole_eval.py <../examples/isaacgym/ppo_cartpole_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/isaacgym/ppo_cartpole_eval.py
                    :language: python
                    :emphasize-lines: 65

.. raw:: html

   <hr>

Isaac Gym environments (learning by scopes)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of 3 agents by scopes in Isaac Gym's Cartpole environment in the same run (**multiple agents and environments**)

.. image:: ../_static/imgs/example_parallel.jpg
      :width: 100%
      :align: center
      :alt: Simultaneous training

.. raw:: html

   <br>

Two versions are presented:

    - Simultaneous (sequential) training of agents **sharing the same memory** and whose scopes are automatically selected as equally as possible
    - Simultaneous (sequential and parallel) training and evaluation of agents **with local memory** (no memory sharing) and whose scopes are manually specified and differ from each other

The following components or practices are exemplified (highlighted):

    - Create a shared memory: **Shared memory**
    - Learning by scopes (automatically defined): **Shared memory**
    - Create non-shared memories: **No shared memory**
    - Learning by scopes (manually defined): **No shared memory**
    - Load a checkpoint during evaluation: **Shared memory**, **No shared memory**

.. note::

    Isaac Gym environments implement a functionality to get their configuration from the command line. Because of this feature, setting the :literal:`headless` option from the trainer configuration will not work. In this case, it is necessary to invoke the scripts as follows: :literal:`python script.py headless=True` for Isaac Gym environments (preview 3 and preview 4) or :literal:`python script.py --headless` for Isaac Gym environments (preview 2)

.. tabs::

    .. tab:: Shared memory

        .. tabs::

            .. tab:: Sequential training

                :download:`isaacgym_sequential_shared_memory.py <../examples/isaacgym/isaacgym_sequential_shared_memory.py>`

                .. literalinclude:: ../examples/isaacgym/isaacgym_sequential_shared_memory.py
                    :language: python
                    :emphasize-lines: 75, 149, 156, 163, 174-175

            .. tab:: Sequential evaluation

                :download:`isaacgym_sequential_shared_memory_eval.py <../examples/isaacgym/isaacgym_sequential_shared_memory_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/isaacgym/isaacgym_sequential_shared_memory_eval.py
                    :language: python
                    :emphasize-lines: 113-115, 126

    .. tab:: No shared memory

        .. tabs::

            .. tab:: Sequential training

                :download:`isaacgym_sequential_no_shared_memory.py <../examples/isaacgym/isaacgym_sequential_no_shared_memory.py>`

                .. literalinclude:: ../examples/isaacgym/isaacgym_sequential_no_shared_memory.py
                    :language: python
                    :emphasize-lines: 75-77, 151, 158, 165, 176-177

            .. tab:: Parallel training

                :download:`isaacgym_parallel_no_shared_memory.py <../examples/isaacgym/isaacgym_parallel_no_shared_memory.py>`

                .. literalinclude:: ../examples/isaacgym/isaacgym_parallel_no_shared_memory.py
                    :language: python
                    :emphasize-lines: 13, 67, 176-179

            .. tab:: Sequential eval...

                :download:`isaacgym_sequential_no_shared_memory_eval.py <../examples/isaacgym/isaacgym_sequential_no_shared_memory_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/isaacgym/isaacgym_sequential_no_shared_memory_eval.py
                    :language: python
                    :emphasize-lines: 113-115, 126

            .. tab:: Parallel eval...

                :download:`isaacgym_parallel_no_shared_memory_eval.py <../examples/isaacgym/isaacgym_parallel_no_shared_memory_eval.py>`

                **Note:** It is necessary to adjust the checkpoint path according to the directories generated by the new experiments

                **Note:** Warnings such as :literal:`[skrl:WARNING] Cannot load the <module> module. The agent doesn't have such an instance` can be ignored without problems. The reason for this is that during the evaluation, not all components such as optimizers or other models apart from the policy are defined

                .. literalinclude:: ../examples/isaacgym/isaacgym_parallel_no_shared_memory_eval.py
                    :language: python
                    :emphasize-lines: 115-117, 128

.. raw:: html

   <hr><hr>

Isaac Orbit
-----------

.. contents::
   :depth: 2
   :local:
   :backlinks: none

.. raw:: html

   <hr>

Isaac Orbit environments
^^^^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of an agent in the `Isaac Orbit environments <https://isaac-orbit.github.io/orbit/index.html>`_ (**one agent, multiple environments**)

.. image:: ../_static/imgs/example_isaac_orbit.png
      :width: 100%
      :align: center
      :alt: Isaac Orbit environments

.. raw:: html

   <br>

The following components or practices are exemplified (highlighted):

    - Load and wrap an Isaac Orbit environment: **Ant**

The PPO agent configuration is mapped, as far as possible, from the rl_games' A2C-PPO `configuration for Isaac Orbit environments <https://github.com/NVIDIA-Omniverse/Orbit/tree/main/source/extensions/omni.isaac.orbit_envs/data/rl_games>`_. Shared models or separated models are used depending on the value of the :literal:`network.separate` variable. The following list shows the mapping between the two configurations:configurations

.. code-block:: bash

    # memory
    memory_size = horizon_length

    # agent
    rollouts = horizon_length
    learning_epochs = mini_epochs
    mini_batches = horizon_length * num_envs / minibatch_size
    discount_factor = gamma
    lambda = tau
    learning_rate = learning_rate
    learning_rate_scheduler = skrl.resources.schedulers.torch.KLAdaptiveRL
    learning_rate_scheduler_kwargs = {"kl_threshold": kl_threshold}
    random_timesteps = 0
    learning_starts = 0
    grad_norm_clip = grad_norm
    ratio_clip = e_clip
    value_clip = e_clip
    clip_predicted_values = clip_value
    entropy_loss_scale = entropy_coef
    value_loss_scale = 0.5 * critic_coef
    kl_threshold = 0
    rewards_shaper = lambda rewards, timestep, timesteps: rewards * scale_value

    # trainer
    timesteps = horizon_length * max_epochs

**Benchmark results** are listed in `Benchmark results #32 (NVIDIA Isaac Orbit) <https://github.com/Toni-SM/skrl/discussions/32#discussioncomment-4744446>`_

.. note::

    Isaac Orbit environments implement a functionality to get their configuration from the command line. Because of this feature, setting the :literal:`headless` option from the trainer configuration will not work. In this case, it is necessary to invoke the scripts as follows: :literal:`orbit -p script.py --headless`

.. tabs::

    .. tab:: Isaac Orbit (training)

        .. tabs::

            .. tab:: Isaac-Ant-v0

                :download:`ppo_ant.py <../examples/isaacorbit/ppo_ant.py>`

                .. literalinclude:: ../examples/isaacorbit/ppo_ant.py
                    :language: python
                    :emphasize-lines: 11-12, 54-55

            .. tab:: Isaac-Cartpole-v0

                :download:`ppo_cartpole.py <../examples/isaacorbit/ppo_cartpole.py>`

                .. literalinclude:: ../examples/isaacorbit/ppo_cartpole.py
                    :language: python

            .. tab:: Isaac-Humanoid-v0

                :download:`ppo_humanoid.py <../examples/isaacorbit/ppo_humanoid.py>`

                .. literalinclude:: ../examples/isaacorbit/ppo_humanoid.py
                    :language: python

            .. tab:: Isaac-Lift-Franka-v0

                :download:`ppo_lift_franka.py <../examples/isaacorbit/ppo_lift_franka.py>`

                .. literalinclude:: ../examples/isaacorbit/ppo_lift_franka.py
                    :language: python

            .. tab:: Isaac-Reach-Franka-v0

                :download:`ppo_reach_franka.py <../examples/isaacorbit/ppo_reach_franka.py>`

                .. literalinclude:: ../examples/isaacorbit/ppo_reach_franka.py
                    :language: python

            .. tab:: Isaac-Velocity-Anymal-C-v0

                :download:`ppo_velocity_anymal_c.py <../examples/isaacorbit/ppo_velocity_anymal_c.py>`

                .. literalinclude:: ../examples/isaacorbit/ppo_velocity_anymal_c.py
                    :language: python

.. raw:: html

   <hr><hr>

Omniverse Isaac Gym
-------------------

.. contents::
   :depth: 2
   :local:
   :backlinks: none

.. raw:: html

   <hr>

Omniverse Isaac Gym environments
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

These examples perform the training of an agent in the `Omniverse Isaac Gym environments <https://github.com/NVIDIA-Omniverse/OmniIsaacGymEnvs>`_ (**one agent, multiple environments**)

.. image:: ../_static/imgs/example_omniverse_isaacgym.png
      :width: 100%
      :align: center
      :alt: Isaac Gym environments

.. raw:: html

   <br>

The following components or practices are exemplified (highlighted):

    - Load and wrap an Omniverse Isaac Gym environment: **AllegroHand**, **Ant**, **Anymal**
    - Load and wrap an Omniverse Isaac Gym multi-threaded environment: **Ant (multi-threaded)**, **Cartpole (multi-threaded)**
    - Set an input preprocessor: **AnymalTerrain**, **BallBalance**
    - Set a random seed for reproducibility: **Cartpole**, **Crazyflie**
    - Set a learning rate scheduler: **FrankaCabinet**, **Humanoid**
    - Define a reward shaping function: **Ingenuity**, **Quadcopter**, **ShadowHand**

The PPO agent configuration is mapped, as far as possible, from the rl_games' A2C-PPO `configuration for Omniverse Isaac Gym environments <https://github.com/NVIDIA-Omniverse/OmniIsaacGymEnvs/tree/main/omniisaacgymenvs/cfg/train>`_. Shared models or separated models are used depending on the value of the :literal:`network.separate` variable. The following list shows the mapping between the two configurations:configurations

.. code-block:: bash

    # memory
    memory_size = horizon_length

    # agent
    rollouts = horizon_length
    learning_epochs = mini_epochs
    mini_batches = horizon_length * num_actors / minibatch_size
    discount_factor = gamma
    lambda = tau
    learning_rate = learning_rate
    learning_rate_scheduler = skrl.resources.schedulers.torch.KLAdaptiveRL
    learning_rate_scheduler_kwargs = {"kl_threshold": kl_threshold}
    random_timesteps = 0
    learning_starts = 0
    grad_norm_clip = grad_norm
    ratio_clip = e_clip
    value_clip = e_clip
    clip_predicted_values = clip_value
    entropy_loss_scale = entropy_coef
    value_loss_scale = 0.5 * critic_coef
    kl_threshold = 0
    rewards_shaper = lambda rewards, timestep, timesteps: rewards * scale_value

    # trainer
    timesteps = horizon_length * max_epochs

**Benchmark results** are listed in `Benchmark results #32 (NVIDIA Omniverse Isaac Gym) <https://github.com/Toni-SM/skrl/discussions/32#discussioncomment-3774894>`_

.. note::

    Omniverse Isaac Gym environments implement a functionality to get their configuration from the command line. Because of this feature, setting the :literal:`headless` option from the trainer configuration will not work. In this case, it is necessary to invoke the scripts as follows: :literal:`python script.py headless=True`

.. tabs::

    .. tab:: Omniverse Isaac Gym (training)

        .. tabs::

            .. tab:: AllegroHand

                :download:`ppo_allegro_hand.py <../examples/omniisaacgym/ppo_allegro_hand.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_allegro_hand.py
                    :language: python
                    :emphasize-lines: 11-12, 54-55

            .. tab:: Ant

                :download:`ppo_ant.py <../examples/omniisaacgym/ppo_ant.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_ant.py
                    :language: python
                    :emphasize-lines: 11-12, 54-55

            .. tab:: Ant (multi-threaded)

                :download:`ppo_ant_mt.py <../examples/omniisaacgym/ppo_ant_mt.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_ant_mt.py
                    :language: python
                    :emphasize-lines: 1, 13-14, 56-57, 117, 121

            .. tab:: Anymal

                :download:`ppo_anymal.py <../examples/omniisaacgym/ppo_anymal.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_anymal.py
                    :language: python
                    :emphasize-lines: 11-12, 54-55

            .. tab:: AnymalTerrain

                :download:`ppo_anymal_terrain.py <../examples/omniisaacgym/ppo_anymal_terrain.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_anymal_terrain.py
                    :language: python
                    :emphasize-lines: 9, 99-102

            .. tab:: BallBalance

                :download:`ppo_ball_balance.py <../examples/omniisaacgym/ppo_ball_balance.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_ball_balance.py
                    :language: python
                    :emphasize-lines: 9, 94-97

            .. tab:: Cartpole

                :download:`ppo_cartpole.py <../examples/omniisaacgym/ppo_cartpole.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_cartpole.py
                    :language: python
                    :emphasize-lines: 13, 17

            .. tab:: Cartpole (multi-threaded)

                :download:`ppo_cartpole_mt.py <../examples/omniisaacgym/ppo_cartpole_mt.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_cartpole_mt.py
                    :language: python
                    :emphasize-lines: 1, 13-14, 54-55, 115, 119

            .. tab:: Crazyflie

                :download:`ppo_crazy_flie.py <../examples/omniisaacgym/ppo_crazy_flie.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_crazy_flie.py
                    :language: python
                    :emphasize-lines: 13, 17

            .. tab:: FrankaCabinet

                :download:`ppo_franka_cabinet.py <../examples/omniisaacgym/ppo_franka_cabinet.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_franka_cabinet.py
                    :language: python
                    :emphasize-lines: 8, 82-83

            .. tab:: Humanoid

                :download:`ppo_humanoid.py <../examples/omniisaacgym/ppo_humanoid.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_humanoid.py
                    :language: python
                    :emphasize-lines: 8, 82-83

            .. tab:: Ingenuity

                :download:`ppo_ingenuity.py <../examples/omniisaacgym/ppo_ingenuity.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_ingenuity.py
                    :language: python
                    :emphasize-lines: 93

            .. tab:: Quadcopter

                :download:`ppo_quadcopter.py <../examples/omniisaacgym/ppo_quadcopter.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_quadcopter.py
                    :language: python
                    :emphasize-lines: 93

            .. tab:: ShadowHand

                :download:`ppo_shadow_hand.py <../examples/omniisaacgym/ppo_shadow_hand.py>`

                .. literalinclude:: ../examples/omniisaacgym/ppo_shadow_hand.py
                    :language: python
                    :emphasize-lines: 95

.. raw:: html

   <hr>

Omniverse Isaac Sim (single environment)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

These examples show how to train an agent in an Omniverse Isaac Sim environment that is implemented using the Gym interface (**one agent, one environment**)

.. tabs::

    .. tab:: Isaac Sim 2022.X.X (Cartpole)

        This example performs the training of an agent in the Isaac Sim's Cartpole environment described in the `Creating New RL Environment <https://docs.omniverse.nvidia.com/app_isaacsim/app_isaacsim/tutorial_gym_new_rl_example.html>`_ tutorial

        Use the steps described below to setup and launch the experiment after follow the tutorial

        .. code-block:: bash

            # download the sample code from GitHub in the directory containing the cartpole_task.py script
            wget https://raw.githubusercontent.com/Toni-SM/skrl/main/docs/source/examples/isaacsim/cartpole_example_skrl.py

            # run the experiment
            PYTHON_PATH cartpole_example_skrl.py

        .. raw:: html

            <br>

        :download:`cartpole_example_skrl.py <../examples/isaacsim/cartpole_example_skrl.py>`

        .. literalinclude:: ../examples/isaacsim/cartpole_example_skrl.py
            :language: python

    .. tab:: Isaac Sim 2021.2.1 (JetBot)

        This example performs the training of an agent in the Isaac Sim's JetBot environment. The following components or practices are exemplified (highlighted):

        - Define and instantiate Convolutional Neural Networks (CNN) to learn from 128 X 128 RGB images

        Use the steps described below (for a local workstation or a remote container) to setup and launch the experiment

        .. tabs::

            .. tab:: Local workstation (setup)

                .. code-block:: bash

                    # create a working directory and change to it
                    mkdir ~/.local/share/ov/pkg/isaac_sim-2021.2.1/standalone_examples/api/omni.isaac.jetbot/skrl_example
                    cd ~/.local/share/ov/pkg/isaac_sim-2021.2.1/standalone_examples/api/omni.isaac.jetbot/skrl_example

                    # install the skrl library in editable mode from the working directory
                    ~/.local/share/ov/pkg/isaac_sim-2021.2.1/python.sh -m pip install -e git+https://github.com/Toni-SM/skrl.git#egg=skrl

                    # download the sample code from GitHub
                    wget https://raw.githubusercontent.com/Toni-SM/skrl/main/docs/source/examples/isaacsim/isaacsim_jetbot_ppo.py

                    # copy the Isaac Sim sample environment (JetBotEnv) to the working directory
                    cp ../stable_baselines_example/env.py .

                    # run the experiment
                    ~/.local/share/ov/pkg/isaac_sim-2021.2.1/python.sh isaacsim_jetbot_ppo.py

            .. tab:: Remote container (setup)

                .. code-block:: bash

                    # create a working directory and change to it
                    mkdir /isaac-sim/standalone_examples/api/omni.isaac.jetbot/skrl_example
                    cd /isaac-sim/standalone_examples/api/omni.isaac.jetbot/skrl_example

                    # install the skrl library in editable mode from the working directory
                    /isaac-sim/kit/python/bin/python3 -m pip install -e git+https://github.com/Toni-SM/skrl.git#egg=skrl

                    # download the sample code from GitHub
                    wget https://raw.githubusercontent.com/Toni-SM/skrl/main/docs/source/examples/isaacsim/isaacsim_jetbot_ppo.py

                    # copy the Isaac Sim sample environment (JetBotEnv) to the working directory
                    cp ../stable_baselines_example/env.py .

                    # run the experiment
                    /isaac-sim/python.sh isaacsim_jetbot_ppo.py

        .. raw:: html

            <br>

        :download:`isaacsim_jetbot_ppo.py <../examples/isaacsim/isaacsim_jetbot_ppo.py>`

        .. literalinclude:: ../examples/isaacsim/isaacsim_jetbot_ppo.py
            :language: python
            :emphasize-lines: 24-39, 45, 53-68, 73

.. raw:: html

   <hr><hr>

Real-world examples
-------------------

.. contents::
   :depth: 2
   :local:
   :backlinks: none

These examples show basic real-world use cases to guide and support advanced RL implementations

.. tabs::

    .. tab:: Franka Emika Panda

        **3D reaching task (Franka's gripper must reach a certain target point in space)**. The training was done in Omniverse Isaac Gym. The real robot control is performed through the Python API of a modified version of *frankx* (see `frankx's pull request #44 <https://github.com/pantor/frankx/pull/44>`_), a high-level motion library around *libfranka*. Training and evaluation is performed for both Cartesian and joint control space

        .. raw:: html

            <hr>

        **Implementation** (see details in the table below):

        * The observation space is composed of the episode's normalized progress, the robot joints' normalized positions (:math:`q`) in the interval -1 to 1, the robot joints' velocities (:math:`\dot{q}`) affected by a random uniform scale for generalization, and the target's position in space (:math:`target_{_{XYZ}}`) with respect to the robot's base

        * The action space, bounded in the range -1 to 1, consists of the following. For the joint control it's robot joints' position scaled change. For the Cartesian control it's the end-effector's position (:math:`ee_{_{XYZ}}`) scaled change. The end-effector position frame corresponds to the point where the left finger connects to the gripper base in simulation, whereas in the real world it corresponds to the end of the fingers. The gripper fingers remain closed all the time in both cases

        * The instantaneous reward is the negative value of the Euclidean distance (:math:`\text{d}`) between the robot end-effector and the target point position. The episode terminates when this distance is less than 0.035 meters in simulation (0.075 meters in real-world) or when the defined maximum timestep is reached

        * The target position lies within a rectangular cuboid of dimensions 0.5 x 0.5 x 0.2 meters centered at (0.5, 0.0, 0.2) meters with respect to the robot's base. The robot joints' positions are drawn from an initial configuration [0º, -45º, 0º, -135º, 0º, 90º, 45º] modified with uniform random values between -7º and 7º approximately

        .. list-table::
            :header-rows: 1

            * - Variable
              - Formula / value
              - Size
            * - Observation space
              - :math:`\dfrac{t}{t_{max}},\; 2 \dfrac{q - q_{min}}{q_{max} - q_{min}} - 1,\; 0.1\,\dot{q}\,U(0.5,1.5),\; target_{_{XYZ}}`
              - 18
            * - Action space (joint)
              - :math:`\dfrac{2.5}{120} \, \Delta q`
              - 7
            * - Action space (Cartesian)
              - :math:`\dfrac{1}{100} \, \Delta ee_{_{XYZ}}`
              - 3
            * - Reward
              - :math:`-\text{d}(ee_{_{XYZ}},\; target_{_{XYZ}})`
              -
            * - Episode termination
              - :math:`\text{d}(ee_{_{XYZ}},\; target_{_{XYZ}}) \le 0.035 \quad` or :math:`\quad t \ge t_{max} - 1`
              -
            * - Maximum timesteps (:math:`t_{max}`)
              - 100
              -

        .. raw:: html

            <hr>

        **Workflows**

        .. tabs::

            .. tab:: Real-world

                .. warning::

                    Make sure you have the e-stop on hand in case something goes wrong in the run. **Control via RL can be dangerous and unsafe for both the operator and the robot**

                .. raw:: html

                    <video width="100%" controls autoplay>
                        <source src="https://user-images.githubusercontent.com/22400377/190899202-6b80c48d-fc49-48e9-b277-24814d0adab1.mp4" type="video/mp4">
                    </video>
                    <strong>Target position entered via the command prompt or generated randomly</strong>
                    <br><br>
                    <video width="100%" controls autoplay>
                        <source src="https://user-images.githubusercontent.com/22400377/190899205-752f654e-9310-4696-a6b2-bfa57d5325f2.mp4" type="video/mp4">
                    </video>
                    <strong>Target position in X and Y obtained with a USB-camera (position in Z fixed at 0.2 m)</strong>

                |

                **Prerequisites:**

                A physical Franka Emika Panda robot with `Franka Control Interface (FCI) <https://frankaemika.github.io/docs/index.html>`_ is required. Additionally, the *frankx* library must be available in the python environment (see `frankx's pull request #44 <https://github.com/pantor/frankx/pull/44>`_ for the RL-compatible version installation)

                **Files**

                * Environment: :download:`reaching_franka_real_env.py <../examples/real_world/franka_emika_panda/reaching_franka_real_env.py>`
                * Evaluation script: :download:`reaching_franka_real_skrl_eval.py <../examples/real_world/franka_emika_panda/reaching_franka_real_skrl_eval.py>`
                * Checkpoints (:literal:`agent_joint.pt`, :literal:`agent_cartesian.pt`): :download:`trained_checkpoints.zip <https://github.com/Toni-SM/skrl/files/9595293/trained_checkpoints.zip>`

                **Evaluation:**

                .. code-block:: bash

                    python3 reaching_franka_real_skrl_eval.py

                **Main environment configuration:**

                .. note::

                    In the joint control space the final control of the robot is performed through the Cartesian pose (forward kinematics from specified values for the joints)

                The control space (Cartesian or joint), the robot motion type (waypoint or impedance) and the target position acquisition (command prompt / automatically generated or USB-camera) can be specified in the environment class constructor (from :literal:`reaching_franka_real_skrl_eval.py`) as follow:

                .. code-block:: python

                    control_space = "joint"   # joint or cartesian
                    motion_type = "waypoint"  # waypoint or impedance
                    camera_tracking = False   # True for USB-camera tracking

            .. tab:: Simulation (Omniverse Isaac Gym)

                .. raw:: html

                    <video width="100%" controls autoplay>
                        <source src="https://user-images.githubusercontent.com/22400377/211668430-7cd4668b-e79a-46a9-bdbc-3212388b6b6d.mp4" type="video/mp4">
                    </video>

                .. raw:: html

                    <img width="100%" src="https://user-images.githubusercontent.com/22400377/190921341-6feb255a-04d4-4e51-bc7a-f939116dd02d.png">

                |

                **Prerequisites:**

                All installation steps described in Omniverse Isaac Gym's `Overview & Getting Started <https://docs.omniverse.nvidia.com/app_isaacsim/app_isaacsim/tutorial_gym_isaac_gym.html>`_ section must be fulfilled (especially the subsection 1.3. Installing Examples Repository)

                **Files** (the implementation is self-contained so no specific location is required):

                * Environment: :download:`reaching_franka_omniverse_isaacgym_env.py <../examples/real_world/franka_emika_panda/reaching_franka_omniverse_isaacgym_env.py>`
                * Training script: :download:`reaching_franka_omniverse_isaacgym_skrl_train.py <../examples/real_world/franka_emika_panda/reaching_franka_omniverse_isaacgym_skrl_train.py>`
                * Evaluation script: :download:`reaching_franka_omniverse_isaacgym_skrl_eval.py <../examples/real_world/franka_emika_panda/reaching_franka_omniverse_isaacgym_skrl_eval.py>`
                * Checkpoints (:literal:`agent_joint.pt`, :literal:`agent_cartesian.pt`): :download:`trained_checkpoints.zip <https://github.com/Toni-SM/skrl/files/9595293/trained_checkpoints.zip>`

                **Training and evaluation:**

                .. code-block:: bash

                    # training (local workstation)
                    ~/.local/share/ov/pkg/isaac_sim-*/python.sh reaching_franka_omniverse_isaacgym_skrl_train.py

                    # training (docker container)
                    /isaac-sim/python.sh reaching_franka_omniverse_isaacgym_skrl_train.py

                .. code-block:: bash

                    # evaluation (local workstation)
                    ~/.local/share/ov/pkg/isaac_sim-*/python.sh reaching_franka_omniverse_isaacgym_skrl_eval.py

                    # evaluation (docker container)
                    /isaac-sim/python.sh reaching_franka_omniverse_isaacgym_skrl_eval.py

                **Main environment configuration:**

                The control space (Cartesian or joint) can be specified in the task configuration dictionary (from :literal:`reaching_franka_omniverse_isaacgym_skrl_train.py`) as follow:

                .. code-block:: python

                    TASK_CFG["task"]["env"]["controlSpace"] = "joint"  # "joint" or "cartesian"

            .. tab:: Simulation (Isaac Gym)

                .. raw:: html

                    <video width="100%" controls autoplay>
                        <source src="https://user-images.githubusercontent.com/22400377/193537523-e0f0f8ad-2295-410c-ba9a-2a16c827a498.mp4" type="video/mp4">
                    </video>

                .. raw:: html

                    <img width="100%" src="https://user-images.githubusercontent.com/22400377/193546966-bcf966e6-98d8-4b41-bc15-bd7364a79381.png">

                |

                **Prerequisites:**

                All installation steps described in Isaac Gym's `Installation <https://github.com/NVIDIA-Omniverse/IsaacGymEnvs#installation>`_ section must be fulfilled

                **Files** (the implementation is self-contained so no specific location is required):

                * Environment: :download:`reaching_franka_isaacgym_env.py <../examples/real_world/franka_emika_panda/reaching_franka_isaacgym_env.py>`
                * Training script: :download:`reaching_franka_isaacgym_skrl_train.py <../examples/real_world/franka_emika_panda/reaching_franka_isaacgym_skrl_train.py>`
                * Evaluation script: :download:`reaching_franka_isaacgym_skrl_eval.py <../examples/real_world/franka_emika_panda/reaching_franka_isaacgym_skrl_eval.py>`

                **Training and evaluation:**

                .. note::

                    The checkpoints obtained in Isaac Gym were not evaluated with the real robot. However, they were evaluated in Omniverse Isaac Gym showing successful performance

                .. code-block:: bash

                    # training (with the Python virtual environment active)
                    python reaching_franka_isaacgym_skrl_train.py

                .. code-block:: bash

                    # evaluation (with the Python virtual environment active)
                    python reaching_franka_isaacgym_skrl_eval.py

                **Main environment configuration:**

                The control space (Cartesian or joint) can be specified in the task configuration dictionary (from :literal:`reaching_franka_isaacgym_skrl_train.py`) as follow:

                .. code-block:: python

                    TASK_CFG["env"]["controlSpace"] = "joint"  # "joint" or "cartesian"

    .. tab:: Kuka LBR iiwa

        **3D reaching task (iiwa's end-effector must reach a certain target point in space)**. The training was done in Omniverse Isaac Gym. The real robot control is performed through the Python, ROS and ROS2 APIs of `libiiwa <https://libiiwa.readthedocs.io>`_, a scalable multi-control framework for the KUKA LBR Iiwa robots. Training and evaluation is performed for both Cartesian and joint control space

        .. raw:: html

            <hr>

        **Implementation** (see details in the table below):

        * The observation space is composed of the episode's normalized progress, the robot joints' normalized positions (:math:`q`) in the interval -1 to 1, the robot joints' velocities (:math:`\dot{q}`) affected by a random uniform scale for generalization, and the target's position in space (:math:`target_{_{XYZ}}`) with respect to the robot's base

        * The action space, bounded in the range -1 to 1, consists of the following. For the joint control it's robot joints' position scaled change. For the Cartesian control it's the end-effector's position (:math:`ee_{_{XYZ}}`) scaled change

        * The instantaneous reward is the negative value of the Euclidean distance (:math:`\text{d}`) between the robot end-effector and the target point position. The episode terminates when this distance is less than 0.035 meters in simulation (0.075 meters in real-world) or when the defined maximum timestep is reached

        * The target position lies within a rectangular cuboid of dimensions 0.2 x 0.4 x 0.4 meters centered at (0.6, 0.0, 0.4) meters with respect to the robot's base. The robot joints' positions are drawn from an initial configuration [0º, 0º, 0º, -90º, 0º, 90º, 0º] modified with uniform random values between -7º and 7º approximately

        .. list-table::
            :header-rows: 1

            * - Variable
              - Formula / value
              - Size
            * - Observation space
              - :math:`\dfrac{t}{t_{max}},\; 2 \dfrac{q - q_{min}}{q_{max} - q_{min}} - 1,\; 0.1\,\dot{q}\,U(0.5,1.5),\; target_{_{XYZ}}`
              - 18
            * - Action space (joint)
              - :math:`\dfrac{2.5}{120} \, \Delta q`
              - 7
            * - Action space (Cartesian)
              - :math:`\dfrac{1}{100} \, \Delta ee_{_{XYZ}}`
              - 3
            * - Reward
              - :math:`-\text{d}(ee_{_{XYZ}},\; target_{_{XYZ}})`
              -
            * - Episode termination
              - :math:`\text{d}(ee_{_{XYZ}},\; target_{_{XYZ}}) \le 0.035 \quad` or :math:`\quad t \ge t_{max} - 1`
              -
            * - Maximum timesteps (:math:`t_{max}`)
              - 100
              -

        .. raw:: html

            <hr>

        **Workflows**

        .. tabs::

            .. tab:: Real-world

                .. warning::

                    Make sure you have the smartHMI on hand in case something goes wrong in the run. **Control via RL can be dangerous and unsafe for both the operator and the robot**

                .. raw:: html

                    <video width="100%" controls autoplay>
                        <source src="https://user-images.githubusercontent.com/22400377/212192766-9698bfba-af27-41b8-8a11-17ed3d22c020.mp4" type="video/mp4">
                    </video>

                **Prerequisites:**

                A physical Kuka LBR iiwa robot is required. Additionally, the *libiiwa* library must be installed (visit the `libiiwa <https://libiiwa.readthedocs.io>`_ documentation for installation details)

                **Files**

                * Environment: :download:`reaching_iiwa_real_env.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_real_env.py>`
                * Evaluation script: :download:`reaching_iiwa_real_skrl_eval.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_real_skrl_eval.py>`
                * Checkpoints (:literal:`agent_joint.pt`, :literal:`agent_cartesian.pt`): :download:`trained_checkpoints.zip <https://github.com/Toni-SM/skrl/files/10406561/trained_checkpoints.zip>`

                **Evaluation:**

                .. code-block:: bash

                    python3 reaching_iiwa_real_skrl_eval.py

                **Main environment configuration:**

                The control space (Cartesian or joint) can be specified in the environment class constructor (from :literal:`reaching_iiwa_real_skrl_eval.py`) as follow:

                .. code-block:: python

                    control_space = "joint"   # joint or cartesian

            .. tab:: Real-world (ROS/ROS2)

                .. warning::

                    Make sure you have the smartHMI on hand in case something goes wrong in the run. **Control via RL can be dangerous and unsafe for both the operator and the robot**

                .. raw:: html

                    <video width="100%" controls autoplay>
                        <source src="https://user-images.githubusercontent.com/22400377/212192817-12115478-e6a8-4502-b33f-b072664b1959.mp4" type="video/mp4">
                    </video>

                **Prerequisites:**

                A physical Kuka LBR iiwa robot is required. Additionally, the *libiiwa* library must be installed (visit the `libiiwa <https://libiiwa.readthedocs.io>`_ documentation for installation details) and a Robot Operating System (ROS or ROS2) distribution must be available

                **Files**

                * Environment (ROS): :download:`reaching_iiwa_real_ros_env.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_real_ros_env.py>`
                * Environment (ROS2): :download:`reaching_iiwa_real_ros2_env.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_real_ros2_env.py>`
                * Evaluation script: :download:`reaching_iiwa_real_ros_ros2_skrl_eval.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_real_ros_ros2_skrl_eval.py>`
                * Checkpoints (:literal:`agent_joint.pt`, :literal:`agent_cartesian.pt`): :download:`trained_checkpoints.zip <https://github.com/Toni-SM/skrl/files/10406561/trained_checkpoints.zip>`

                .. note::

                    Source the ROS/ROS2 distribution and the ROS/ROS workspace containing the libiiwa packages before executing the scripts

                **Evaluation:**

                .. note::

                    The environment (:literal:`reaching_iiwa_real_ros_env.py` or :literal:`reaching_iiwa_real_ros2_env.py`) to be loaded will be automatically selected based on the sourced ROS distribution (ROS or ROS2) at script execution

                .. code-block:: bash

                    python3 reaching_iiwa_real_ros_ros2_skrl_eval.py

                **Main environment configuration:**

                The control space (Cartesian or joint) can be specified in the environment class constructor (from :literal:`reaching_iiwa_real_ros_ros2_skrl_eval.py`) as follow:

                .. code-block:: python

                    control_space = "joint"   # joint or cartesian

            .. tab:: Simulation (Omniverse Isaac Gym)

                .. raw:: html

                    <video width="100%" controls autoplay>
                        <source src="https://user-images.githubusercontent.com/22400377/211668313-7bcbcd41-cde5-441e-abb4-82fff7616f06.mp4" type="video/mp4">
                    </video>

                .. raw:: html

                    <img width="100%" src="https://user-images.githubusercontent.com/22400377/212194442-f6588b98-38af-4f29-92a3-3c853a7e31f4.png">

                |

                **Prerequisites:**

                All installation steps described in Omniverse Isaac Gym's `Overview & Getting Started <https://docs.omniverse.nvidia.com/app_isaacsim/app_isaacsim/tutorial_gym_isaac_gym.html>`_ section must be fulfilled (especially the subsection 1.3. Installing Examples Repository)

                **Files** (the implementation is self-contained so no specific location is required):

                * Environment: :download:`reaching_iiwa_omniverse_isaacgym_env.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_omniverse_isaacgym_env.py>`
                * Training script: :download:`reaching_iiwa_omniverse_isaacgym_skrl_train.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_omniverse_isaacgym_skrl_train.py>`
                * Evaluation script: :download:`reaching_iiwa_omniverse_isaacgym_skrl_eval.py <../examples/real_world/kuka_lbr_iiwa/reaching_iiwa_omniverse_isaacgym_skrl_eval.py>`
                * Checkpoints (:literal:`agent_joint.pt`, :literal:`agent_cartesian.pt`): :download:`trained_checkpoints.zip <https://github.com/Toni-SM/skrl/files/10406561/trained_checkpoints.zip>`
                * Simulation files: (.usd assets and robot class): :download:`simulation_files.zip <https://github.com/Toni-SM/skrl/files/10409551/simulation_files.zip>`


                Simulation files must be structured as follows:

                .. code-block::

                    <some_folder>
                        ├── agent_cartesian.pt
                        ├── agent_joint.pt
                        ├── assets
                        │   ├── iiwa14_instanceable_meshes.usd
                        │   └── iiwa14.usd
                        ├── reaching_iiwa_omniverse_isaacgym_env.py
                        ├── reaching_iiwa_omniverse_isaacgym_skrl_eval.py
                        ├── reaching_iiwa_omniverse_isaacgym_skrl_train.py
                        ├── robots
                        │   ├── iiwa14.py
                        │   └── __init__.py

                **Training and evaluation:**

                .. code-block:: bash

                    # training (local workstation)
                    ~/.local/share/ov/pkg/isaac_sim-*/python.sh reaching_iiwa_omniverse_isaacgym_skrl_train.py

                    # training (docker container)
                    /isaac-sim/python.sh reaching_iiwa_omniverse_isaacgym_skrl_train.py

                .. code-block:: bash

                    # evaluation (local workstation)
                    ~/.local/share/ov/pkg/isaac_sim-*/python.sh reaching_iiwa_omniverse_isaacgym_skrl_eval.py

                    # evaluation (docker container)
                    /isaac-sim/python.sh reaching_iiwa_omniverse_isaacgym_skrl_eval.py

                **Main environment configuration:**

                The control space (Cartesian or joint) can be specified in the task configuration dictionary (from :literal:`reaching_iiwa_omniverse_isaacgym_skrl_train.py`) as follow:

                .. code-block:: python

                    TASK_CFG["task"]["env"]["controlSpace"] = "joint"  # "joint" or "cartesian"

.. raw:: html

   <hr><hr>

.. _library_utilities:

Library utilities (skrl.utils module)
-------------------------------------

.. contents::
   :depth: 2
   :local:
   :backlinks: none

This example shows how to use the library utilities to carry out the post-processing of files and data generated by the experiments

.. tabs::

    .. tab:: Tensorboard files

        .. image:: ../_static/imgs/utils_tensorboard_file_iterator.svg
            :width: 100%
            :alt: Tensorboard file iterator

        .. raw:: html

            <br><br>

        Example of a figure, generated by the code, showing the total reward (left) and the mean and standard deviation (right) of all experiments located in the runs folder

        :download:`tensorboard_file_iterator.py <../examples/utils/tensorboard_file_iterator.py>`

        **Note:** The code will load all the Tensorboard files of the experiments located in the :literal:`runs` folder. It is necessary to adjust the iterator's parameters for other paths

        .. literalinclude:: ../examples/utils/tensorboard_file_iterator.py
            :language: python
            :emphasize-lines: 4, 11-13
